document.addEventListener('DOMContentLoaded', () => {
    // --- SELECTORES ---
    const mainAppUI = document.getElementById('main-app-ui');
    const views = { setup: document.getElementById('setup-view'), dashboard: document.getElementById('dashboard-view'), details: document.getElementById('details-view'), form: document.getElementById('form-view'), settings: document.getElementById('settings-view'), zen: document.getElementById('zen-view'), schedule: document.getElementById('schedule-view'), subjectForm: document.getElementById('subject-form-view'), calendar: document.getElementById('calendar-view') };
    const buttons = {
        backToDashboard: document.getElementById('back-to-dashboard-btn'), editTask: document.getElementById('edit-task-btn'), cancelForm: document.getElementById('cancel-form-btn'), saveTask: document.getElementById('save-task-btn'),
        exportData: document.getElementById('export-btn'), importData: document.getElementById('import-btn'), resetApp: document.getElementById('reset-app-btn'),
        desktopDashboard: document.getElementById('desktop-dashboard-btn'), desktopSchedule: document.getElementById('desktop-schedule-btn'), desktopCalendar: document.getElementById('desktop-calendar-btn'), desktopSettings: document.getElementById('desktop-settings-btn'), desktopAddTask: document.getElementById('desktop-add-task-btn'),
        mobileDashboard: document.getElementById('mobile-dashboard-btn'), mobileSchedule: document.getElementById('mobile-schedule-btn'), mobileCalendar: document.getElementById('mobile-calendar-btn'), mobileSettings: document.getElementById('mobile-settings-btn'), mobileAddTask: document.getElementById('mobile-add-task-btn'),
        saveWallpaperUrl: document.getElementById('save-wallpaper-url-btn'), resetWallpaper: document.getElementById('reset-wallpaper-btn'),
        startZenSession: document.getElementById('start-zen-session-btn'), exitZen: document.getElementById('exit-zen-btn'),
        dashboardZen: document.getElementById('dashboard-zen-btn'), // BotÃ³n Zen del Dashboard
        addSubject: document.getElementById('add-subject-btn'), cancelSubjectForm: document.getElementById('cancel-subject-form-btn'), saveSubject: document.getElementById('save-subject-btn'),
        calendarPrevMonth: document.getElementById('calendar-prev-month-btn'), calendarNextMonth: document.getElementById('calendar-next-month-btn'),
    };
    const inputs = { username: document.getElementById('username-input'), importFile: document.getElementById('import-file-input'), wallpaperUrl: document.getElementById('wallpaper-url-input'), wallpaperFile: document.getElementById('wallpaper-file-input') };
    const containers = {
        pendingTasks: document.getElementById('pending-tasks-container'), taskDetails: document.getElementById('task-details-content'), subtasksFormList: document.getElementById('subtasks-form-list'),
        greetingText: document.getElementById('greeting-text'), dashboardSummary: document.getElementById('dashboard-summary'), motivationalQuote: document.getElementById('motivational-quote'),
        focusCard: document.getElementById('focus-card-container'), taskFilters: document.getElementById('task-filters'), streak: document.getElementById('streak-text'),
        scheduleList: document.getElementById('schedule-list-container'), calendarGrid: document.getElementById('calendar-grid'), calendarTitle: document.getElementById('calendar-title'), calendarTasks: document.getElementById('calendar-tasks-container'),
    };
    const formElements = {
        setupForm: document.getElementById('setup-form'), form: document.getElementById('task-form'), formTitle: document.getElementById('form-title'), taskIdInput: document.getElementById('task-id-input'), title: document.getElementById('task-title'),
        description: document.getElementById('task-description'), dueDate: document.getElementById('task-due-date'), priority: document.getElementById('task-priority'), tags: document.getElementById('task-tags'),
        subjectForm: document.getElementById('subject-form'), subjectFormTitle: document.getElementById('subject-form-title'), subjectIdInput: document.getElementById('subject-id-input'),
        subjectName: document.getElementById('subject-name'), subjectDay: document.getElementById('subject-day'), subjectStartTime: document.getElementById('subject-start-time'), subjectEndTime: document.getElementById('subject-end-time'),
    };
    const modal = { element: document.getElementById('subtask-modal'), input: document.getElementById('subtask-input'), confirmBtn: document.getElementById('confirm-add-subtask-btn'), cancelBtn: document.getElementById('cancel-add-subtask-btn'), addBtnForm: document.getElementById('add-subtask-form-btn') };
    const zen = {
        timerDisplay: document.getElementById('zen-timer-display'), statusText: document.getElementById('zen-status-text'), canvas: document.getElementById('zen-canvas'),
        borderTop: document.getElementById('border-top'), borderRight: document.getElementById('border-right'), borderBottom: document.getElementById('border-bottom'), borderLeft: document.getElementById('border-left'),
        pomodoroDurationInput: document.getElementById('zen-pomodoro-duration'), shortBreakDurationInput: document.getElementById('zen-short-break-duration'), longBreakDurationInput: document.getElementById('zen-long-break-duration'),
        colorSelector: document.getElementById('zen-color-selector'), soundSelector: document.getElementById('zen-sound-selector'), volumeSlider: document.getElementById('zen-volume-slider'),
        confirmLogModal: document.getElementById('confirm-zen-log-modal'), confirmLogContent: document.getElementById('confirm-zen-log-content')
    };
    const achievementToast = { element: document.getElementById('achievement-toast'), content: document.getElementById('achievement-toast-content') };

    // --- ESTADO Y LÃ“GICA DE DATOS ---
    const motivationalQuotes = [ "El secreto para salir adelante es empezar.", "La disciplina es el puente entre las metas y los logros.", "No mires el reloj; haz lo que Ã©l hace. Sigue moviÃ©ndote." ];
    const sounds = [ { id: 'rain', name: 'Lluvia Ligera', element: document.getElementById('audio-rain') }, { id: 'forest', name: 'Bosque', element: document.getElementById('audio-forest') }, { id: 'whitenoise', name: 'Ruido Blanco', element: document.getElementById('audio-whitenoise') } ];
    const getDefaultState = () => ({ userName: null, tasks: [], schedule: [], currentView: 'dashboard', selectedTaskId: null, selectedSubjectId: null, tempSubtasks: [], calendarDate: new Date().toISOString(), wallpaper: null, filters: { priority: 'all', tag: 'all' }, zenSettings: { pomodoro: 25, shortBreak: 5, longBreak: 15, color: '#00F0FF' }, gamification: { streak: 0, lastCompletionDate: null, achievements: [], pomodoroCount: 0 }, currentZenTaskId: null });
    let state = getDefaultState();
    let countdownInterval = null, taskObserver = null;
    let zenState = { timerId: null, particleAnimationId: null, currentSound: null };
    const dataService = {
        async getData() { return new Promise(resolve => { const d = localStorage.getItem('fluir-app-data-v6'); resolve(d ? { ...getDefaultState(), ...JSON.parse(d) } : getDefaultState()); }); },
        async saveData(appState) { return new Promise(resolve => { localStorage.setItem('fluir-app-data-v6', JSON.stringify(appState)); resolve(); }); }
    };
    const achievementDefs = { 'focusMaster': { name: 'Maestro del Enfoque', description: 'Completa 10 sesiones Pomodoro.', icon: 'ðŸ†', condition: (s) => s.gamification.pomodoroCount >= 10 }, 'firstStep': { name: 'Primer Paso', description: 'Completa tu primera tarea.', icon: 'ðŸŽ‰', condition: (s) => s.tasks.some(t => t.completed) }, 'weekStreak': { name: 'Imparable', description: 'MantÃ©n una racha de 7 dÃ­as.', icon: 'ðŸš€', condition: (s) => s.gamification.streak >= 7 } };
    async function checkAchievements() { let unlocked = false; for (const id in achievementDefs) { if (!state.gamification.achievements.includes(id) && achievementDefs[id].condition(state)) { state.gamification.achievements.push(id); showAchievementToast(achievementDefs[id]); unlocked = true; } } if (unlocked) await dataService.saveData(state); }
    function showAchievementToast(achievement) { achievementToast.content.innerHTML = `<span class="text-3xl">${achievement.icon}</span><div><h3 class="font-bold text-lg">${achievement.name}</h3><p class="text-sm">${achievement.description}</p></div>`; achievementToast.element.style.setProperty('--accent-primary', state.zenSettings.color); achievementToast.element.classList.add('show'); setTimeout(() => achievementToast.element.classList.remove('show'), 5000); }
    async function updateStreak() { const today = new Date().toISOString().split('T')[0]; if (state.gamification.lastCompletionDate !== today) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); state.gamification.streak = state.gamification.lastCompletionDate === yesterday.toISOString().split('T')[0] ? state.gamification.streak + 1 : 1; state.gamification.lastCompletionDate = today; await dataService.saveData(state); await checkAchievements(); } }
    async function exportData() { if (!state.userName) return; const dataStr = JSON.stringify({ ...state, wallpaper: state.wallpaper?.startsWith('data:') ? null : state.wallpaper }, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `fluir_backup_${new Date().toISOString().split('T')[0]}.flu`; a.click(); URL.revokeObjectURL(a.href); }
    function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const imported = JSON.parse(e.target.result); if (!imported.userName) throw new Error("Formato invÃ¡lido."); if (confirm("Â¿Sobrescribir datos actuales?")) { state = { ...getDefaultState(), ...imported }; await dataService.saveData(state); location.reload(); } } catch (err) { alert(`Error: ${err.message}`); } }; reader.readAsText(file); event.target.value = ''; }
    async function resetApp() { if(confirm("Â¡ADVERTENCIA! Se borrarÃ¡n todos los datos.")){ localStorage.clear(); location.reload(); } }
    function applyAppearance() { document.body.style.backgroundImage = `url('${state.wallpaper || "https://raw.githubusercontent.com/lucasromerodb/liquid-glass-effect-macos/refs/heads/main/assets/flowers.jpg"}')`; document.documentElement.style.setProperty('--accent-primary', state.zenSettings.color); }
    async function handleWallpaperUrl() { const url = inputs.wallpaperUrl.value.trim(); if (url) { state.wallpaper = url; await dataService.saveData(state); applyAppearance(); } }
    function handleWallpaperFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async e => { state.wallpaper = e.target.result; await dataService.saveData(state); applyAppearance(); }; reader.readAsDataURL(file); }
    async function resetWallpaper() { state.wallpaper = null; await dataService.saveData(state); applyAppearance(); inputs.wallpaperUrl.value = ''; inputs.wallpaperFile.value = ''; }

    // --- NAVEGACIÃ“N Y RENDERIZADO ---
    function navigateTo(viewName) { if (countdownInterval) clearInterval(countdownInterval); if (taskObserver) taskObserver.disconnect(); if (state.currentView === 'zen' && viewName !== 'zen') stopZenMode(); const currentViewElement = views[state.currentView], nextViewElement = views[viewName]; if (currentViewElement && nextViewElement) { currentViewElement.classList.add('is-exiting'); setTimeout(() => { currentViewElement.classList.remove('active', 'is-exiting'); currentViewElement.style.display = 'none'; nextViewElement.style.display = 'block'; nextViewElement.classList.add('active', 'is-entering'); setTimeout(() => nextViewElement.classList.remove('is-entering'), 400); state.currentView = viewName; updateNavActiveState(viewName); window.scrollTo(0, 0); if (viewName === 'dashboard') renderDashboard(); if (viewName === 'settings') renderSettings(); if (viewName === 'schedule') renderSchedule(); if (viewName === 'calendar') renderCalendar(); if (viewName === 'zen') startZenMode(); }, 400); } }
    function updateNavActiveState(activeView) { document.querySelectorAll('.desktop-nav-btn, .mobile-nav-btn').forEach(btn => btn.classList.remove('active')); const desktopBtn = document.getElementById(`desktop-${activeView}-btn`); if(desktopBtn) desktopBtn.classList.add('active'); const mobileBtn = document.getElementById(`mobile-${activeView}-btn`); if(mobileBtn) mobileBtn.classList.add('active'); }
    function updateCountdownTimers() { document.querySelectorAll('.countdown-timer.is-visible').forEach(timer => { const diff = new Date(timer.dataset.dueDate) - new Date(); if (diff <= 0) { timer.innerHTML = `<span style="color: var(--danger-color);" class="font-bold">Vencido</span>`; return; } const d = Math.floor(diff / 864e5), h = Math.floor((diff % 864e5) / 36e5), m = Math.floor((diff % 36e5) / 6e4), s = Math.floor((diff % 6e4) / 1e3); timer.textContent = `${d > 0 ? d + 'd ' : ''}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; }); }
    function startCountdownTimers() { if (!countdownInterval) { updateCountdownTimers(); countdownInterval = setInterval(updateCountdownTimers, 1000); } }
    function setupTaskObserver() { if (taskObserver) taskObserver.disconnect(); taskObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const timer = entry.target.querySelector('.countdown-timer'); if (timer) entry.isIntersecting ? timer.classList.add('is-visible') : timer.classList.remove('is-visible'); }); }, { threshold: 0.1 }); document.querySelectorAll('.task-card').forEach(card => taskObserver.observe(card)); }
    function createProgressCircle(percentage, size = 40) { const sW = size / 10, r = (size / 2) - (sW / 2), c = 2 * Math.PI * r, o = c - (percentage / 100) * c; return `<svg style="width:${size}px; height:${size}px;" viewBox="0 0 ${size} ${size}"><circle stroke-width="${sW}" stroke="rgba(255,255,255,0.3)" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}"/><circle stroke-width="${sW}" stroke-dasharray="${c}" stroke-dashoffset="${o}" stroke-linecap="round" stroke="var(--text-primary)" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}" style="transition: stroke-dashoffset 0.5s ease; transform: rotate(-90deg); transform-origin: center;"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" class="font-bold" style="fill: var(--text-primary); font-size: ${size / 4.5}px;">${Math.round(percentage)}%</text></svg>`; }
    function createTaskCard(task) { let progress = 0, statusText = ''; if (task.subtasks.length > 0) { const completed = task.subtasks.filter(st => st.completed).length; progress = (completed / task.subtasks.length) * 100; statusText = `${completed}/${task.subtasks.length}`; } else { progress = task.completed ? 100 : 0; statusText = task.completed ? 'Â¡Hecho!' : 'Simple'; } const card = document.createElement('div'); card.className = `task-card glass-pane p-4 priority-${task.priority}`; card.dataset.taskId = task.id; let timeInfoHTML = ''; if(task.dueDate && !task.completed) { timeInfoHTML = `<p class="text-sm text-secondary">Entrega: ${new Date(task.dueDate).toLocaleString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p><p class="text-sm font-semibold countdown-timer" data-due-date="${task.dueDate}"></p>`; } else { timeInfoHTML = `<p class="text-sm text-secondary">${task.completed ? 'Completado' : 'Sin fecha'}</p>`; } const tagsHTML = task.tags.map(tag => `<span class="tag">${tag}</span>`).join(''); card.innerHTML = `<div class="flex justify-between items-center"><div class="flex-grow mr-4 min-w-0"><h3 class="font-bold text-lg break-words ${task.completed ? 'line-through text-secondary' : ''}">${task.title}</h3>${timeInfoHTML}<div class="flex gap-2 mt-2 flex-wrap">${tagsHTML}</div></div><div class="flex-shrink-0 flex flex-col items-center justify-center">${createProgressCircle(progress, 60)}<span class="text-xs font-semibold mt-1">${statusText}</span></div></div>`; card.addEventListener('click', () => { state.selectedTaskId = task.id; renderTaskDetails(); navigateTo('details'); }); return card; }
    function renderDashboard() { containers.greetingText.textContent = `Hola, ${state.userName}!`; const pendingCount = state.tasks.filter(t => !t.completed).length; containers.dashboardSummary.textContent = pendingCount > 0 ? `Tienes ${pendingCount} tarea${pendingCount > 1 ? 's' : ''} pendiente${pendingCount > 1 ? 's' : ''}.` : 'Â¡No tienes tareas pendientes!'; containers.motivationalQuote.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]; containers.streak.textContent = `${state.gamification.streak} dÃ­a${state.gamification.streak !== 1 ? 's' : ''}`; renderTaskFilters(); renderFocusCard(); const activeTasks = state.tasks.filter(t => !t.completed).sort((a, b) => (a.dueDate && b.dueDate) ? new Date(a.dueDate) - new Date(b.dueDate) : a.dueDate ? -1 : 1); const filteredTasks = activeTasks.filter(t => (state.filters.priority === 'all' || t.priority === state.filters.priority) && (state.filters.tag === 'all' || t.tags.includes(state.filters.tag))); containers.pendingTasks.innerHTML = ''; if (filteredTasks.length > 0) { filteredTasks.forEach(task => containers.pendingTasks.appendChild(createTaskCard(task))); } else { containers.pendingTasks.innerHTML = `<div class="glass-pane p-6 text-center col-span-full"><h3 class="font-heading text-xl uppercase">Todo en orden</h3><p class="mt-1 text-sm text-secondary">No hay tareas que coincidan con tus filtros.</p></div>`; } startCountdownTimers(); setupTaskObserver(); }
    function renderFocusCard() { containers.focusCard.innerHTML = ''; const focusTask = state.tasks.filter(t => !t.completed && t.dueDate).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0]; if (focusTask) { const card = createTaskCard(focusTask); card.classList.add('focus-card', 'glass-pane-light'); containers.focusCard.appendChild(card); } else { containers.focusCard.innerHTML = `<div class="glass-pane glass-pane-light p-6 text-center"><h3 class="font-heading text-xl uppercase">Todo tranquilo</h3><p class="mt-1 text-sm text-secondary">No hay tareas urgentes. Â¡Disfruta o aÃ±ade un proyecto!</p></div>`; } }
    function renderTaskFilters() { const allTags = [...new Set(state.tasks.flatMap(t => t.tags))]; containers.taskFilters.innerHTML = `<select id="priority-filter" class="input-field !py-1 !w-auto"><option value="all">Prioridad</option><option value="high">Alta</option><option value="medium">Media</option><option value="low">Baja</option></select><select id="tag-filter" class="input-field !py-1 !w-auto"><option value="all">Etiqueta</option>${allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}</select>`; const priorityFilter = document.getElementById('priority-filter'), tagFilter = document.getElementById('tag-filter'); priorityFilter.value = state.filters.priority; tagFilter.value = state.filters.tag; priorityFilter.addEventListener('change', (e) => { state.filters.priority = e.target.value; renderDashboard(); }); tagFilter.addEventListener('change', (e) => { state.filters.tag = e.target.value; renderDashboard(); }); }
    async function renderTaskDetails() { const task = state.tasks.find(t => t.id === state.selectedTaskId); if (!task) return; let progress = 0; if (task.subtasks.length > 0) { const completed = task.subtasks.filter(st => st.completed).length; progress = (completed / task.subtasks.length) * 100; } else { progress = task.completed ? 100 : 0; } let detailsHTML = `<div class="flex flex-col items-center w-full"><div class="mb-6">${createProgressCircle(progress, 120)}</div><h2 class="font-heading text-3xl md:text-5xl uppercase mb-2 text-center break-words ${task.completed ? 'line-through text-secondary' : ''}">${task.title}</h2><div class="text-sm text-secondary mb-2 text-center">Prioridad: <span class="font-bold">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span></div>${task.tags.length > 0 ? `<div class="flex gap-2 justify-center flex-wrap mb-6">${task.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}<p class="mb-8 text-center w-full max-w-2xl">${task.description || '<em>Sin descripciÃ³n.</em>'}</p><div class="w-full border-t-2 border-white/20 pt-6">`; if (task.subtasks.length > 0) { const comp = task.subtasks.filter(st => st.completed).length; const total = task.subtasks.length; const subsHTML = task.subtasks.map(st => `<div class="subtask-item flex items-center gap-4 p-3 border-b-2 border-white/10" draggable="true" data-subtask-id="${st.id}"><span class="drag-handle text-secondary cursor-move">â ¿</span><input type="checkbox" id="subtask-${st.id}" data-subtask-id="${st.id}" class="custom-checkbox" ${st.completed ? 'checked' : ''}><label for="subtask-${st.id}" class="flex-1 ${st.completed ? 'line-through text-secondary' : ''}">${st.text}</label></div>`).join(''); detailsHTML += `<h3 class="font-heading text-xl uppercase mb-4">Progreso (${comp}/${total})</h3><div id="subtasks-details-list">${subsHTML}</div><button id="add-subtask-details-btn" class="mt-4 btn text-sm">+ AÃ±adir subtarea</button>`; } else { detailsHTML += `<div class="flex justify-center"><label for="complete-task-checkbox" class="flex items-center gap-4 cursor-pointer"><input type="checkbox" id="complete-task-checkbox" class="custom-checkbox w-8 h-8" ${task.completed ? 'checked' : ''}><span class="text-xl font-bold">Marcar como completada</span></label></div>`; } detailsHTML += `</div></div>`; containers.taskDetails.innerHTML = detailsHTML; setupSubtaskDragAndDrop('subtasks-details-list', task.id); if (task.subtasks.length > 0) { document.querySelectorAll('#subtasks-details-list input[type="checkbox"]').forEach(cb => { cb.addEventListener('change', async e => { const subtask = task.subtasks.find(st => st.id === e.target.dataset.subtaskId); if(subtask) { subtask.completed = e.target.checked; task.completed = task.subtasks.every(st => st.completed); if (task.completed) await updateStreak(); await dataService.saveData(state); await renderTaskDetails(); } }); }); document.getElementById('add-subtask-details-btn').addEventListener('click', () => { openSubtaskModal(); }); } else { document.getElementById('complete-task-checkbox').addEventListener('change', async e => { task.completed = e.target.checked; if (task.completed) await updateStreak(); await dataService.saveData(state); await renderTaskDetails(); }); } }
    function renderFormSubtasks() { containers.subtasksFormList.innerHTML = state.tempSubtasks.map((st, i) => `<div class="subtask-item flex items-center justify-between p-2 rounded-lg" style="background: rgba(0,0,0,0.2);" draggable="true" data-index="${i}"><span class="drag-handle text-secondary cursor-move">â ¿</span><span class="flex-1 px-2 text-secondary">${st.text}</span><button type="button" class="font-bold text-red-500 px-2" data-index="${i}">Ã—</button></div>`).join(''); containers.subtasksFormList.querySelectorAll('button').forEach(btn => btn.addEventListener('click', e => { state.tempSubtasks.splice(e.target.dataset.index, 1); renderFormSubtasks(); })); setupSubtaskDragAndDrop('subtasks-form-list'); }
    function renderSettings() { zen.pomodoroDurationInput.value = state.zenSettings.pomodoro; zen.shortBreakDurationInput.value = state.zenSettings.shortBreak; zen.longBreakDurationInput.value = state.zenSettings.longBreak; zen.colorSelector.querySelectorAll('button').forEach(b => b.style.border = b.dataset.color === state.zenSettings.color ? '3px solid white' : '3px solid transparent'); inputs.wallpaperUrl.value = (state.wallpaper && !state.wallpaper.startsWith('data:')) ? state.wallpaper : ''; }
    function setupSubtaskDragAndDrop(containerId, taskId = null) { const list = document.getElementById(containerId); let draggedItem = null; list.addEventListener('dragstart', e => { draggedItem = e.target.closest('.subtask-item'); setTimeout(() => draggedItem?.classList.add('dragging'), 0); }); list.addEventListener('dragend', () => { draggedItem?.classList.remove('dragging'); draggedItem = null; }); list.addEventListener('dragover', e => { e.preventDefault(); const afterElement = [...list.querySelectorAll('.subtask-item:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; const currentDragged = document.querySelector('.dragging'); if (afterElement == null) { list.appendChild(currentDragged); } else { list.insertBefore(currentDragged, afterElement); } }); list.addEventListener('drop', async e => { e.preventDefault(); const newOrder = Array.from(list.querySelectorAll('.subtask-item')).map(item => taskId ? item.dataset.subtaskId : parseInt(item.dataset.index)); if (taskId) { const task = state.tasks.find(t => t.id === taskId); if (task) { task.subtasks.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id)); await dataService.saveData(state); } } else { state.tempSubtasks.sort((a, b) => newOrder.indexOf(state.tempSubtasks.indexOf(a)) - newOrder.indexOf(state.tempSubtasks.indexOf(b))); } }); }
    function openSubtaskModal() { modal.element.classList.add('active'); modal.input.value = ''; modal.input.focus(); }
    function closeSubtaskModal() { modal.element.classList.remove('active'); }
    async function handleAddSubtask() { const text = modal.input.value.trim(); if (!text) return; if (state.currentView === 'form') { state.tempSubtasks.push({ text, completed: false }); renderFormSubtasks(); } else { const task = state.tasks.find(t => t.id === state.selectedTaskId); if (task) { task.subtasks.push({ id: `sub-${Date.now()}`, text, completed: false }); await dataService.saveData(state); await renderTaskDetails(); } } closeSubtaskModal(); }
    function openNewTaskForm() { state.selectedTaskId = null; formElements.form.reset(); formElements.form.querySelector('#save-task-btn').textContent = 'Crear Proyecto'; formElements.formTitle.textContent = 'Nuevo Proyecto'; state.tempSubtasks = []; renderFormSubtasks(); navigateTo('form'); }
    function openEditTaskForm(taskId) { const task = state.tasks.find(t => t.id === taskId); if (!task) return; state.selectedTaskId = taskId; formElements.form.reset(); formElements.form.querySelector('#save-task-btn').textContent = 'Guardar Cambios'; formElements.formTitle.textContent = 'Editar Proyecto'; formElements.title.value = task.title; formElements.description.value = task.description; if (task.dueDate) { formElements.dueDate.value = new Date(new Date(task.dueDate).getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16); } formElements.priority.value = task.priority || 'medium'; formElements.tags.value = task.tags ? task.tags.join(', ') : ''; state.tempSubtasks = JSON.parse(JSON.stringify(task.subtasks)); renderFormSubtasks(); navigateTo('form'); }
    
    // --- LÃ“GICA DE HORARIO Y CALENDARIO ---
    function renderSchedule() { containers.scheduleList.innerHTML = ''; if (state.schedule.length === 0) { containers.scheduleList.innerHTML = `<div class="text-center p-4"><h3 class="font-heading text-xl uppercase">Horario VacÃ­o</h3><p class="mt-1 text-sm text-secondary">AÃ±ade tu primera materia para empezar.</p></div>`; return; } const days = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado']; const scheduleByDay = days.map((_, dayIndex) => state.schedule.filter(s => s.day === dayIndex).sort((a,b) => a.startTime.localeCompare(b.startTime))); days.forEach((dayName, dayIndex) => { if (scheduleByDay[dayIndex].length > 0) { const dayGroup = document.createElement('div'); dayGroup.className = 'schedule-day-group'; let dayHTML = `<h3 class="font-heading text-2xl uppercase pb-2 border-b-2 border-white/20 mb-4">${dayName}</h3><div class="space-y-3">`; scheduleByDay[dayIndex].forEach(s => { dayHTML += `<div class="glass-pane p-4 flex justify-between items-center cursor-pointer" data-subject-id="${s.id}"><span class="font-bold">${s.name}</span><span class="text-secondary font-semibold">${s.startTime} - ${s.endTime}</span></div>`; }); dayHTML += `</div>`; dayGroup.innerHTML = dayHTML; containers.scheduleList.appendChild(dayGroup); } }); containers.scheduleList.querySelectorAll('[data-subject-id]').forEach(el => el.addEventListener('click', (e) => openEditSubjectForm(e.currentTarget.dataset.subjectId))); }
    function openNewSubjectForm() { state.selectedSubjectId = null; formElements.subjectForm.reset(); formElements.subjectFormTitle.textContent = 'Nueva Materia'; formElements.saveSubject.textContent = 'AÃ±adir Materia'; navigateTo('subjectForm'); }
    function openEditSubjectForm(subjectId) { const subject = state.schedule.find(s => s.id === subjectId); if (!subject) return; state.selectedSubjectId = subjectId; formElements.subjectForm.reset(); formElements.subjectFormTitle.textContent = 'Editar Materia'; formElements.saveSubject.textContent = 'Guardar Cambios'; formElements.subjectName.value = subject.name; formElements.subjectDay.value = subject.day; formElements.subjectStartTime.value = subject.startTime; formElements.subjectEndTime.value = subject.endTime; navigateTo('subjectForm'); }
    function renderCalendar() { const calDate = new Date(state.calendarDate); const y = calDate.getFullYear(), m = calDate.getMonth(); containers.calendarTitle.textContent = calDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase(); const firstDay = new Date(y, m, 1).getDay(); const daysInMonth = new Date(y, m + 1, 0).getDate(); containers.calendarGrid.innerHTML = ['D', 'L', 'M', 'X', 'J', 'V', 'S'].map(d => `<div class="font-bold text-secondary">${d}</div>`).join(''); for (let i = 0; i < firstDay; i++) containers.calendarGrid.innerHTML += `<div></div>`; const tasksByDate = {}; state.tasks.forEach(task => { if(task.dueDate){ const date = task.dueDate.split('T')[0]; if(!tasksByDate[date]) tasksByDate[date] = []; tasksByDate[date].push(task); }}); for (let day = 1; day <= daysInMonth; day++) { const el = document.createElement('div'); const fullDate = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; el.textContent = day; el.dataset.date = fullDate; if (tasksByDate[fullDate]) el.classList.add('has-task'); el.addEventListener('click', () => { document.querySelectorAll('#calendar-grid > div').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); renderTasksForDay(fullDate, tasksByDate[fullDate] || []); }); containers.calendarGrid.appendChild(el); } }
    function renderTasksForDay(dateStr, tasks) { const date = new Date(dateStr + 'T00:00:00'); containers.calendarTasks.innerHTML = `<h3 class="font-heading text-xl uppercase mb-2">Tareas para el ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}</h3>`; if(tasks.length > 0) { containers.calendarTasks.innerHTML += tasks.map(task => `<div class="glass-pane p-3 cursor-pointer" data-task-id="${task.id}">${task.title}</div>`).join(''); containers.calendarTasks.querySelectorAll('[data-task-id]').forEach(el => el.addEventListener('click', e => { state.selectedTaskId = e.currentTarget.dataset.taskId; renderTaskDetails(); navigateTo('details'); })); } else { containers.calendarTasks.innerHTML += `<p class="text-secondary">No hay tareas programadas.</p>`; } }

    // --- LÃ“GICA MODO ZEN ---
    function startZenMode(cycleType = 'pomodoro', cycleCount = 0) { if (zenState.timerId) clearInterval(zenState.timerId); views.zen.classList.add('active'); let duration, statusText; switch(cycleType) { case 'shortBreak': duration = state.zenSettings.shortBreak * 60; statusText = 'DESCANSO CORTO'; break; case 'longBreak': duration = state.zenSettings.longBreak * 60; statusText = 'DESCANSO LARGO'; break; default: duration = state.zenSettings.pomodoro * 60; statusText = 'ENFOQUE'; } zen.statusText.textContent = statusText; let timeLeft = duration; zenState.timerId = setInterval(async () => { timeLeft--; const minutes = Math.floor(timeLeft / 60), seconds = timeLeft % 60; zen.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; updateBorderClock((duration - timeLeft) / duration); if (timeLeft <= 0) { clearInterval(zenState.timerId); if (cycleType === 'pomodoro') { state.gamification.pomodoroCount++; await updateStreak(); await dataService.saveData(state); if (state.currentZenTaskId) showZenLogConfirmation(); const newCycleCount = cycleCount + 1; startZenMode((newCycleCount % 4 === 0) ? 'longBreak' : 'shortBreak', newCycleCount); } else { startZenMode('pomodoro', cycleCount); } } }, 1000); startParticleAnimation(); }
    function stopZenMode() { if (zenState.timerId) clearInterval(zenState.timerId); if (zenState.particleAnimationId) cancelAnimationFrame(zenState.particleAnimationId); views.zen.classList.remove('active'); updateBorderClock(0); state.currentZenTaskId = null; if (zenState.currentSound) { zenState.currentSound.pause(); zenState.currentSound.currentTime = 0; zenState.currentSound = null; } }
    function updateBorderClock(p) { zen.borderTop.style.width = `${Math.min(p * 4, 1) * 100}%`; zen.borderRight.style.height = `${Math.min(Math.max(p * 4 - 1, 0), 1) * 100}%`; zen.borderBottom.style.width = `${Math.min(Math.max(p * 4 - 2, 0), 1) * 100}%`; zen.borderLeft.style.height = `${Math.min(Math.max(p * 4 - 3, 0), 1) * 100}%`; }
    function showZenLogConfirmation() { const task = state.tasks.find(t => t.id === state.currentZenTaskId); if (!task) return; zen.confirmLogContent.innerHTML = `<h2 class="font-heading text-2xl uppercase mb-4">SesiÃ³n Completada</h2><p class="mb-6 text-secondary">Â¿Registrar ${state.zenSettings.pomodoro} min en la tarea "${task.title}"?</p><div class="flex gap-4"><button id="confirm-log-yes" class="flex-1 btn btn-primary">SÃ­</button><button id="confirm-log-no" class="flex-1 btn">No</button></div>`; zen.confirmLogModal.classList.add('active'); document.getElementById('confirm-log-yes').onclick = async () => { if (!task.zenSessions) task.zenSessions = []; task.zenSessions.push({ date: new Date().toISOString(), duration: state.zenSettings.pomodoro }); await dataService.saveData(state); zen.confirmLogModal.classList.remove('active'); state.currentZenTaskId = null; }; document.getElementById('confirm-log-no').onclick = () => { zen.confirmLogModal.classList.remove('active'); state.currentZenTaskId = null; }; }
    function startParticleAnimation() { const ctx = zen.canvas.getContext('2d'); let particles = []; zen.canvas.width = window.innerWidth; zen.canvas.height = window.innerHeight; class Particle { constructor() { this.angle = Math.random() * Math.PI * 2; this.radius = 0; this.speed = Math.random() * 0.5 + 0.1; this.size = Math.random() * 2 + 1; this.color = state.zenSettings.color; } update(pulse) { this.radius += this.speed; const pulseEffect = this.radius * (0.15 * pulse); this.x = zen.canvas.width / 2 + Math.cos(this.angle) * (this.radius + pulseEffect); this.y = zen.canvas.height / 2 + Math.sin(this.angle) * (this.radius + pulseEffect); } draw() { ctx.globalAlpha = 1 - (this.radius / (zen.canvas.width / 2)); ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; } } for (let i = 0; i < 200; i++) particles.push(new Particle()); function animate() { ctx.clearRect(0, 0, zen.canvas.width, zen.canvas.height); const pulse = (1 + Math.sin(Date.now() / 800)) / 2; for (let i = 0; i < particles.length; i++) { particles[i].update(pulse); particles[i].draw(); if (particles[i].radius > zen.canvas.width / 2) { particles.splice(i, 1, new Particle()); } } zenState.particleAnimationId = requestAnimationFrame(animate); } animate(); }
    function renderZenSoundControls() { zen.soundSelector.innerHTML = sounds.map(s => `<button data-sound-id="${s.id}" class="sound-select-btn w-full text-left p-2 rounded-lg hover:bg-white/10 transition-colors">${s.name}</button>`).join(''); zen.soundSelector.querySelectorAll('.sound-select-btn').forEach(btn => btn.addEventListener('click', () => { const sound = sounds.find(s => s.id === btn.dataset.soundId); if (zenState.currentSound === sound.element) { zenState.currentSound.pause(); zenState.currentSound = null; btn.classList.remove('active'); } else { sounds.forEach(s => s.element.pause()); zenState.currentSound = sound.element; zenState.currentSound.volume = zen.volumeSlider.value; zenState.currentSound.play(); document.querySelectorAll('.sound-select-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } })); }

    // --- EVENT HANDLERS ---
    formElements.setupForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = inputs.username.value.trim(); if(name){ state.userName = name; await dataService.saveData(state); views.setup.style.display = 'none'; mainAppUI.style.display = 'block'; renderDashboard(); navigateTo('dashboard'); } });
    [buttons.desktopAddTask, buttons.mobileAddTask].forEach(btn => btn.addEventListener('click', openNewTaskForm));
    buttons.backToDashboard.addEventListener('click', () => navigateTo('dashboard'));
    buttons.editTask.addEventListener('click', () => { if (state.selectedTaskId) openEditTaskForm(state.selectedTaskId); });
    buttons.cancelForm.addEventListener('click', () => { state.selectedTaskId ? navigateTo('details') : navigateTo('dashboard'); });
    buttons.startZenSession.addEventListener('click', () => { state.currentZenTaskId = state.selectedTaskId; navigateTo('zen'); });
    buttons.dashboardZen.addEventListener('click', () => { state.currentZenTaskId = null; navigateTo('zen'); });
    buttons.exitZen.addEventListener('click', () => navigateTo('dashboard'));
    formElements.form.addEventListener('submit', async (e) => { e.preventDefault(); const title = formElements.title.value.trim(); if (!title) return; const tags = formElements.tags.value.split(',').map(t => t.trim()).filter(t => t); const commonData = { title, description: formElements.description.value.trim(), dueDate: formElements.dueDate.value, priority: formElements.priority.value, tags, subtasks: state.tempSubtasks.map((st, i) => ({ id: st.id || `sub-${Date.now()}-${i}`, text: st.text, completed: st.completed || false })) }; if (state.selectedTaskId) { const taskIndex = state.tasks.findIndex(t => t.id === state.selectedTaskId); if (taskIndex > -1) { const originalTask = state.tasks[taskIndex]; state.tasks[taskIndex] = { ...originalTask, ...commonData, completed: commonData.subtasks.length > 0 ? commonData.subtasks.every(st => st.completed) : originalTask.completed }; } } else { state.tasks.push({ ...commonData, id: `task-${Date.now()}`, createdAt: new Date().toISOString(), completed: false }); } await dataService.saveData(state); state.selectedTaskId ? renderTaskDetails() : renderDashboard(); navigateTo(state.selectedTaskId ? 'details' : 'dashboard'); });
    [buttons.desktopDashboard, buttons.mobileDashboard].forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard')));
    [buttons.desktopSchedule, buttons.mobileSchedule].forEach(btn => btn.addEventListener('click', () => navigateTo('schedule')));
    [buttons.desktopCalendar, buttons.mobileCalendar].forEach(btn => btn.addEventListener('click', () => navigateTo('calendar')));
    [buttons.desktopSettings, buttons.mobileSettings].forEach(btn => btn.addEventListener('click', () => navigateTo('settings')));
    buttons.addSubject.addEventListener('click', openNewSubjectForm);
    buttons.cancelSubjectForm.addEventListener('click', () => navigateTo('schedule'));
    formElements.subjectForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = formElements.subjectName.value.trim(); if (!name) return; const subjectData = { name, day: parseInt(formElements.subjectDay.value), startTime: formElements.subjectStartTime.value, endTime: formElements.subjectEndTime.value }; if (state.selectedSubjectId) { const index = state.schedule.findIndex(s => s.id === state.selectedSubjectId); if (index > -1) state.schedule[index] = { ...state.schedule[index], ...subjectData }; } else { state.schedule.push({ ...subjectData, id: `sub-${Date.now()}` }); } await dataService.saveData(state); renderSchedule(); navigateTo('schedule'); });
    buttons.calendarPrevMonth.addEventListener('click', () => { const d = new Date(state.calendarDate); d.setMonth(d.getMonth() - 1); state.calendarDate = d.toISOString(); renderCalendar(); });
    buttons.calendarNextMonth.addEventListener('click', () => { const d = new Date(state.calendarDate); d.setMonth(d.getMonth() + 1); state.calendarDate = d.toISOString(); renderCalendar(); });
    buttons.importData.addEventListener('click', () => inputs.importFile.click());
    inputs.importFile.addEventListener('change', importData);
    buttons.exportData.addEventListener('click', exportData);
    buttons.resetApp.addEventListener('click', resetApp);
    modal.addBtnForm.addEventListener('click', openSubtaskModal); 
    modal.confirmBtn.addEventListener('click', handleAddSubtask); 
    modal.cancelBtn.addEventListener('click', closeSubtaskModal);
    modal.input.addEventListener('keydown', e => { if (e.key === 'Enter') handleAddSubtask(); });
    buttons.saveWallpaperUrl.addEventListener('click', handleWallpaperUrl);
    inputs.wallpaperFile.addEventListener('change', handleWallpaperFile);
    buttons.resetWallpaper.addEventListener('click', resetWallpaper);
    zen.pomodoroDurationInput.addEventListener('change', async (e) => { state.zenSettings.pomodoro = parseInt(e.target.value); await dataService.saveData(state); });
    zen.shortBreakDurationInput.addEventListener('change', async (e) => { state.zenSettings.shortBreak = parseInt(e.target.value); await dataService.saveData(state); });
    zen.longBreakDurationInput.addEventListener('change', async (e) => { state.zenSettings.longBreak = parseInt(e.target.value); await dataService.saveData(state); });
    zen.colorSelector.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async () => { state.zenSettings.color = btn.dataset.color; applyAppearance(); renderSettings(); await dataService.saveData(state); }));
    zen.volumeSlider.addEventListener('input', e => { if (zenState.currentSound) zenState.currentSound.volume = e.target.value; });

    // --- INICIALIZACIÃ“N ---
    async function init() {
        state = await dataService.getData();
        applyAppearance();
        renderZenSoundControls();
        if (state.userName) {
            mainAppUI.style.display = 'block';
            renderDashboard();
            navigateTo('dashboard');
            await checkAchievements();
        } else {
            views.setup.style.display = 'flex';
        }
    }
    
    init();

    // --- SERVICE WORKER ---
    if ('serviceWorker' in navigator) { 
        window.addEventListener('load', () => { 
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registrado correctamente.'))
                .catch(e => console.log('Error al registrar el Service Worker:', e)); 
        }); 
    }
});