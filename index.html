<!DOCTYPE html>
<html lang="es" data-theme="default-light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluir - Gestión de Tareas y Horarios</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kdam+Thmor+Pro&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Paletas de Temas */
        :root { --bg-env: #EAEAFE; --bg-main: #FFFFFF; --text-primary: #000000; --text-secondary: #4a4a4a; --accent-primary: #C8FF00; --card-color-1: #E0D7FF; --card-color-2: #FFF3B0; --border-color: #000000; }
        [data-theme="pastel-dream-light"] { --bg-env: #F0F8FF; --bg-main: #FFFFFF; --text-primary: #333333; --text-secondary: #5f5f5f; --accent-primary: #FFD1DC; --card-color-1: #B0E0E6; --card-color-2: #98FB98; --border-color: #333333; }
        [data-theme="mint-choco-light"] { --bg-env: #F5FFFA; --bg-main: #FFFFFF; --text-primary: #3D2B1F; --text-secondary: #654321; --accent-primary: #AFE1AF; --card-color-1: #E0D7FF; --card-color-2: #D2B48C; --border-color: #3D2B1F; }
        [data-theme="autumn-crisp-light"] { --bg-env: #FFF8E1; --bg-main: #FFFFFF; --text-primary: #4E342E; --text-secondary: #6D4C41; --accent-primary: #FFAB91; --card-color-1: #FFCC80; --card-color-2: #A5D6A7; --border-color: #4E342E; }
        [data-theme="beach-day-light"] { --bg-env: #E0F7FA; --bg-main: #FFFFFF; --text-primary: #004D40; --text-secondary: #00695C; --accent-primary: #FFD180; --card-color-1: #B2EBF2; --card-color-2: #FFF59D; --border-color: #004D40; }
        [data-theme="deep-space-dark"] { --bg-env: #0C0A1A; --bg-main: #1A1A2E; --text-primary: #E0E0E0; --text-secondary: #a0a0a0; --accent-primary: #E94560; --card-color-1: #16213E; --card-color-2: #0F3460; --border-color: #E0E0E0; }
        [data-theme="forest-night-dark"] { --bg-env: #1A201A; --bg-main: #2A312A; --text-primary: #E8F5E9; --text-secondary: #a5d6a7; --accent-primary: #A5D6A7; --card-color-1: #384738; --card-color-2: #556B55; --border-color: #E8F5E9; }
        [data-theme="vampire-dark"] { --bg-env: #121212; --bg-main: #1E1E1E; --text-primary: #EAEAEA; --text-secondary: #b3b3b3; --accent-primary: #CF6679; --card-color-1: #3700B3; --card-color-2: #BB86FC; --border-color: #EAEAEA; }
        [data-theme="cyberpunk-dark"] { --bg-env: #0d0221; --bg-main: #26174a; --text-primary: #c9f9ff; --text-secondary: #8ef9f3; --accent-primary: #f0f; --card-color-1: #5d31a5; --card-color-2: #077187; --border-color: #c9f9ff; }
        [data-theme="cozy-autumn-dark"] { --bg-env: #2C1E18; --bg-main: #422D23; --text-primary: #FFE0B2; --text-secondary: #ffcc80; --accent-primary: #FF8A65; --card-color-1: #A1887F; --card-color-2: #795548; --border-color: #FFE0B2; }

        html { scroll-behavior: smooth; }
        
        /* Corrección: Se centraliza el padding del body aquí para evitar conflictos con clases de Tailwind. */
        body { 
            background-color: var(--bg-env); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-primary); 
            transition: background-color 0.3s ease, color 0.3s ease; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 1rem;
            padding-bottom: 7rem; /* Espacio para la barra de navegación móvil */
        }
        
        @media (min-width: 768px) { /* md breakpoint */
            body {
                padding-left: 2rem;
                padding-right: 2rem;
                padding-bottom: 2rem;
                padding-top: 7rem; /* Espacio para el header fijo en desktop */
            }
        }

        .font-heading { font-family: 'Kdam Thmor Pro', sans-serif; }
        .neo-brutalist { border: 2px solid var(--border-color); box-shadow: 4px 4px 0px var(--border-color); transition: all 0.15s ease-out, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; border-radius: 0.5rem; }
        .neo-brutalist-flat { border: 2px solid var(--border-color); border-radius: 0.5rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .btn-primary { background-color: var(--accent-primary); }
        .btn-primary:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--border-color); }
        .btn-secondary { background-color: var(--bg-main); }
        .btn-secondary:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--border-color); }
        .task-card, .class-card { transition: all 0.2s ease-out; }
        .task-card:hover, .class-card:hover { transform: translate(-4px, -4px); box-shadow: 8px 8px 0px var(--border-color); }
        .input-field { background-color: var(--bg-main); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem 1rem; width: 100%; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-primary); }
        .custom-checkbox { appearance: none; background-color: var(--bg-main); width: 1.5rem; height: 1.5rem; border: 2px solid var(--border-color); border-radius: 0.25rem; cursor: pointer; display: grid; place-content: center; flex-shrink: 0; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .custom-checkbox::before { content: ''; width: 0.75rem; height: 0.75rem; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em var(--text-primary); transform-origin: bottom left; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: var(--accent-primary); }
        .custom-checkbox:checked::before { transform: scale(1); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal-overlay.active .modal-content { background-color: var(--bg-main); transform: scale(1); }
        .view { display: none; animation-duration: 0.4s; animation-fill-mode: forwards; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .view.is-entering { animation-name: fadeIn; }
        .view.is-exiting { animation-name: fadeOut; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-env); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .text-secondary { color: var(--text-secondary); }
        .mobile-nav-btn.active, .desktop-nav-btn.active { color: var(--accent-primary) !important; text-decoration: underline; }
        .mobile-nav-btn.active svg { color: var(--accent-primary) !important; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-env); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; opacity: 1; transition: opacity 0.5s ease-out; }
        #splash-screen.is-fading { opacity: 0; pointer-events: none; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; border: 2px solid var(--border-color); }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; border: 2px solid var(--border-color); }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        .schedule-day-group { position: relative; }
        .schedule-time-indicator { position: absolute; left: 0; right: 0; height: 2px; background-color: #E94560; z-index: 10; transition: top 0.5s linear; }
        .schedule-time-indicator::before { content: '▶'; position: absolute; left: -20px; top: 50%; transform: translateY(-50%); color: #E94560; }
        .next-class { box-shadow: 0 0 10px 3px var(--accent-primary); transform: scale(1.02); transition: all 0.3s ease-in-out; }
        #reset-app-btn { transition: all 0.15s ease-out; }
        #reset-app-btn:hover { background-color: #fca5a5 !important; transform: translate(-2px, -2px); box-shadow: 6px 6px 0px #dc2626; color: #991b1b; border-color: #dc2626; }

        /* Corrección: Header flotante para pantallas anchas (16:9) con espaciado correcto */
        @media (min-width: 768px) and (min-aspect-ratio: 16/9) {
            #desktop-header {
                top: 1rem;
                left: 50%;
                transform: translateX(-50%);
                width: 95%;
                max-width: 1200px;
                border-radius: 0.75rem;
                border-width: 2px; /* Aplica borde en todos los lados */
                box-shadow: 6px 6px 0px var(--border-color);
            }
            body {
                /* Aumenta el padding superior para dejar espacio al header flotante */
                padding-top: 9rem;
            }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <svg class="w-24 h-24 md:w-32 md:h-32 mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="25" y="25" width="50" height="50" class="neo-brutalist-flat" style="fill: var(--accent-primary); border-width: 4px;"/>
        </svg>
        <h1 class="font-heading text-4xl md:text-5xl uppercase">Fluir</h1>
    </div>

    <header id="desktop-header" class="hidden md:flex fixed top-0 left-0 right-0 z-40 items-center justify-between p-4 border-b-2" style="background-color: var(--bg-main); border-color: var(--border-color);">
        <h1 class="font-heading text-3xl uppercase">Fluir</h1>
        <div id="desktop-nav-links" class="flex items-center gap-6 font-bold text-lg">
            <button id="desktop-dashboard-btn" class="desktop-nav-btn">Inicio</button>
            <button id="desktop-schedule-btn" class="desktop-nav-btn">Horario</button>
            <button id="desktop-calendar-btn" class="desktop-nav-btn">Calendario</button>
            <button id="desktop-settings-btn" class="desktop-nav-btn">Ajustes</button>
        </div>
        <button id="desktop-add-task-btn" class="neo-brutalist btn-primary font-bold flex items-center gap-2 px-4 py-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Añadir Proyecto
        </button>
    </header>
    
    <main id="app-container" class="max-w-7xl mx-auto">
        
        <section id="setup-view" class="view">
            <div class="min-h-[80vh] flex flex-col items-center justify-center text-center p-4">
                <h1 class="font-heading text-4xl md:text-6xl uppercase mb-4">¡Bienvenido/a a Fluir!</h1>
                <p class="text-lg md:text-xl mb-12 max-w-2xl mx-auto text-secondary">Antes de empezar, dinos cómo te llamas.</p>
                <form id="setup-form" class="w-full max-w-sm">
                    <input type="text" id="username-input" class="input-field text-center text-2xl mb-8" placeholder="Escribe tu nombre aquí..." required>
                    <button type="submit" class="neo-brutalist btn-primary font-bold text-xl md:text-2xl px-12 py-4">COMENZAR</button>
                </form>
            </div>
        </section>

        <section id="dashboard-view" class="view">
            <div id="greeting-section" class="mb-12 p-6 neo-brutalist-flat" style="background-color: var(--bg-main);">
                <h1 id="greeting-text" class="font-heading text-3xl md:text-4xl uppercase"></h1>
                <p id="dashboard-summary" class="text-secondary text-lg mt-1"></p>
                <p id="motivational-quote" class="mt-4 italic text-secondary"></p>
            </div>

            <div id="upcoming-classes-section" class="mb-12">
                <h2 class="font-heading text-2xl uppercase mb-4">Próximas Clases</h2>
                <div id="upcoming-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="pending-tasks-section" class="mb-12">
                <h2 class="font-heading text-2xl uppercase mb-4">Tareas Pendientes</h2>
                <div id="pending-tasks-container" class="space-y-4"></div>
            </div>

            <div id="completed-tasks-section" class="hidden mt-12">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-heading text-2xl uppercase">Completadas</h2>
                    <button id="toggle-completed-btn" class="neo-brutalist btn-secondary text-sm font-bold px-3 py-1.5">Mostrar</button>
                </div>
                <div id="completed-tasks-container" class="space-y-4 hidden"></div>
            </div>
        </section>

        <section id="details-view" class="view">
             <div class="p-4 md:p-6 neo-brutalist-flat" style="background-color: var(--bg-main);">
                <header class="flex justify-between items-center mb-6 pb-4 border-b-2" style="border-color: var(--border-color);">
                    <button id="back-to-dashboard-btn" class="neo-brutalist btn-secondary font-bold flex items-center gap-2 px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                        Volver
                    </button>
                    <button id="edit-task-btn" class="neo-brutalist btn-secondary font-bold flex items-center gap-2 px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Editar
                    </button>
                </header>
                <div id="task-details-content"></div>
            </div>
        </section>

        <section id="form-view" class="view">
             <div class="p-4 md:p-6 neo-brutalist-flat max-w-3xl mx-auto" style="background-color: var(--bg-main);">
                 <header class="flex justify-between items-center mb-6"><h1 id="form-title" class="font-heading text-3xl md:text-4xl uppercase">Nuevo Proyecto</h1><button id="cancel-form-btn" class="neo-brutalist btn-secondary font-bold px-4 py-2">Cancelar</button></header>
                <form id="task-form">
                    <input type="hidden" id="task-id-input">
                    <div class="mb-6"><label for="task-title" class="font-bold block mb-2">Título del Proyecto *</label><input type="text" id="task-title" class="input-field" required></div>
                    <div class="mb-6"><label for="task-description" class="font-bold block mb-2">Descripción</label><textarea id="task-description" rows="4" class="input-field"></textarea></div>
                    <div class="mb-6"><label for="task-due-date" class="font-bold block mb-2">Fecha y Hora de Entrega</label><input type="datetime-local" id="task-due-date" class="input-field"></div>
                    <div class="mb-6"><label class="font-bold block mb-2">Color de la Tarjeta</label><div class="flex gap-4"><div class="flex items-center gap-2"><input type="radio" id="color-1" name="task-color" value="var(--card-color-1)" class="custom-checkbox" checked><label for="color-1" class="p-2 rounded" style="background-color: var(--card-color-1); border: 2px solid var(--border-color);">Color 1</label></div><div class="flex items-center gap-2"><input type="radio" id="color-2" name="task-color" value="var(--card-color-2)" class="custom-checkbox"><label for="color-2" class="p-2 rounded" style="background-color: var(--card-color-2); border: 2px solid var(--border-color);">Color 2</label></div></div></div>
                    <div class="mb-8"><h3 class="font-bold mb-2">Subtareas</h3><div id="subtasks-form-list" class="space-y-2 mb-3"></div><button type="button" id="add-subtask-form-btn" class="neo-brutalist btn-secondary text-sm font-bold px-3 py-1.5">+ Añadir subtarea</button></div>
                    <button type="submit" id="save-task-btn" class="w-full neo-brutalist btn-primary font-bold text-xl py-3">Crear Proyecto</button>
                </form>
            </div>
        </section>

        <section id="subject-form-view" class="view">
            <div class="p-4 md:p-6 neo-brutalist-flat max-w-3xl mx-auto" style="background-color: var(--bg-main);">
                <header class="flex justify-between items-center mb-6"><h1 id="subject-form-title" class="font-heading text-3xl md:text-4xl uppercase">Nueva Materia</h1><button id="cancel-subject-form-btn" class="neo-brutalist btn-secondary font-bold px-4 py-2">Cancelar</button></header>
               <form id="subject-form">
                   <input type="hidden" id="subject-id-input">
                   <div class="mb-6"><label for="subject-name" class="font-bold block mb-2">Nombre de la Materia *</label><input type="text" id="subject-name" class="input-field" required></div>
                   <div class="mb-6"><label for="subject-day" class="font-bold block mb-2">Día de la Semana *</label>
                        <select id="subject-day" class="input-field" required>
                            <option value="1">Lunes</option><option value="2">Martes</option><option value="3">Miércoles</option><option value="4">Jueves</option><option value="5">Viernes</option><option value="6">Sábado</option><option value="0">Domingo</option>
                        </select>
                   </div>
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                       <div><label for="subject-start-time" class="font-bold block mb-2">Hora de Inicio *</label><input type="time" id="subject-start-time" class="input-field" required></div>
                       <div><label for="subject-end-time" class="font-bold block mb-2">Hora de Fin *</label><input type="time" id="subject-end-time" class="input-field" required></div>
                   </div>
                   <button type="submit" id="save-subject-btn" class="w-full neo-brutalist btn-primary font-bold text-xl py-3">Añadir Materia</button>
               </form>
           </div>
       </section>

        <section id="settings-view" class="view">
            <div class="p-4 md:p-6 neo-brutalist-flat max-w-4xl mx-auto" style="background-color: var(--bg-main);">
                <h1 class="font-heading text-3xl uppercase mb-6">Configuración</h1>
                <div class="mb-12">
                    <h2 class="font-heading text-2xl uppercase mb-4">Apariencia</h2>
                    <div class="flex justify-between items-center mb-8"><span class="font-bold">Modo Inmersivo (Pantalla Completa)</span><label class="switch"><input type="checkbox" id="immersive-mode-switch"><span class="slider"></span></label></div>
                    <div id="theme-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
                </div>
                <div id="grades-section" class="mb-12">
                    <h2 class="font-heading text-2xl uppercase mb-4">Calificaciones</h2>
                    <div id="grades-container" class="space-y-4"></div>
                </div>
                <div class="mb-12">
                    <h2 class="font-heading text-2xl uppercase mb-4">Crear Copia de Seguridad</h2>
                    <button id="export-btn" class="w-full neo-brutalist btn-secondary font-bold text-lg py-3">Exportar a archivo .flu</button><p class="text-sm text-secondary mt-2">Guarda todos tus tareas, horario y calificaciones en un archivo.</p>
                </div>
                <div class="mb-12">
                    <h2 class="font-heading text-2xl uppercase mb-4">Restaurar Copia de Seguridad</h2>
                    <button id="import-btn" class="w-full neo-brutalist btn-secondary font-bold text-lg py-3">Importar desde .flu</button><input type="file" id="import-file-input" accept=".flu,.json" class="hidden"><p class="text-sm text-secondary mt-2">Reemplaza tus datos actuales con los de un archivo de respaldo.</p>
                </div>
                <div>
                    <h2 class="font-heading text-2xl uppercase mb-4 text-red-500">Zona de Peligro</h2>
                    <button id="reset-app-btn" class="w-full neo-brutalist font-bold text-lg py-3 border-red-500 text-red-700" style="background-color: #fee2e2;">Reiniciar Aplicación</button><p class="text-sm text-secondary mt-2">Borra permanentemente todos tus datos y configuraciones.</p>
                </div>
            </div>
        </section>

        <section id="calendar-view" class="view">
            <div class="p-4 md:p-6 neo-brutalist-flat max-w-5xl mx-auto" style="background-color: var(--bg-main);">
                <header class="flex justify-between items-center mb-6">
                    <h1 id="calendar-title-desktop" class="font-heading text-2xl md:text-3xl uppercase">Calendario</h1>
                    <div class="flex items-center gap-2">
                        <button id="calendar-prev-month-btn" class="neo-brutalist btn-secondary font-bold p-2" aria-label="Mes anterior"><</button>
                        <button id="calendar-next-month-btn" class="neo-brutalist btn-secondary font-bold p-2" aria-label="Mes siguiente">></button>
                    </div>
                </header>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center font-bold mb-4"></div>
                <div id="calendar-tasks-list"><h3 class="font-heading text-xl uppercase mb-2">Tareas del día:</h3><div id="calendar-tasks-container" class="space-y-2"><p class="text-secondary">Selecciona un día para ver las tareas.</p></div></div>
            </div>
        </section>

        <section id="schedule-view" class="view">
            <div class="p-4 md:p-6 neo-brutalist-flat max-w-4xl mx-auto" style="background-color: var(--bg-main);">
                <header class="flex justify-between items-center mb-8">
                    <h1 class="font-heading text-3xl md:text-4xl uppercase">Horario Semanal</h1>
                    <button id="add-subject-btn" class="neo-brutalist btn-primary font-bold flex items-center gap-2 px-4 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Añadir Materia
                    </button>
                </header>
                <div id="schedule-list-container" class="space-y-8"></div>
            </div>
        </section>

    </main>
    
    <div id="subtask-modal" class="modal-overlay">
        <div class="modal-content neo-brutalist w-11/12 max-w-md p-6"><h2 class="font-heading text-2xl uppercase mb-4">Añadir Subtarea</h2><input type="text" id="subtask-input" class="input-field mb-4" placeholder="Descripción de la subtarea..."><div class="flex gap-4"><button id="confirm-add-subtask-btn" class="flex-1 neo-brutalist btn-primary font-bold py-2">Añadir</button><button id="cancel-add-subtask-btn" class="flex-1 neo-brutalist btn-secondary font-bold py-2">Cancelar</button></div></div>
    </div>

    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 h-20 grid grid-cols-5 items-center justify-around p-2 border-t-2" style="background-color: var(--bg-main); border-color: var(--border-color); z-index: 40;">
        <button id="mobile-dashboard-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-center"><svg class="w-7 h-7 mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span class="text-xs font-bold">Inicio</span></button>
        <button id="mobile-schedule-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-center"><svg class="w-7 h-7 mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path><path d="M6 4h2v2H6V4z"></path><path d="M6 10h2v2H6v-2z"></path><path d="M6 16h2v2H6v-2z"></path><path d="M12 4h2v2h-2V4z"></path><path d="M12 10h2v2h-2v-2z"></path><path d="M12 16h2v2h-2v-2z"></path></svg><span class="text-xs font-bold">Horario</span></button>
        <div class="flex justify-center"><button id="mobile-add-task-btn" class="neo-brutalist btn-primary w-16 h-16 rounded-full flex items-center justify-center -mt-8" aria-label="Añadir Nuevo Proyecto"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
        <button id="mobile-calendar-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-center"><svg class="w-7 h-7 mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="text-xs font-bold">Calendario</span></button>
        <button id="mobile-settings-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-center"><svg class="w-7 h-7 mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v.77a2 2 0 0 1-1.11 1.79l-1.44.82a2 2 0 0 0-1.11 1.79v4.86a2 2 0 0 0 1.11 1.79l1.44.82a2 2 0 0 1 1.11 1.79v.77a2 2 0 0 0 2 2h4.44a2 2 0 0 0 2-2v-.77a2 2 0 0 1 1.11-1.79l1.44-.82a2 2 0 0 0 1.11-1.79v-4.86a2 2 0 0 0-1.11-1.79l-1.44-.82a2 2 0 0 1-1.11-1.79V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg><span class="text-xs font-bold">Ajustes</span></button>
    </nav>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // SELECTORES DE ELEMENTOS
        const splashScreen = document.getElementById('splash-screen');
        const views = { setup: document.getElementById('setup-view'), dashboard: document.getElementById('dashboard-view'), details: document.getElementById('details-view'), form: document.getElementById('form-view'), settings: document.getElementById('settings-view'), calendar: document.getElementById('calendar-view'), schedule: document.getElementById('schedule-view'), subjectForm: document.getElementById('subject-form-view') };
        const buttons = {
            backToDashboard: document.getElementById('back-to-dashboard-btn'), editTask: document.getElementById('edit-task-btn'), cancelForm: document.getElementById('cancel-form-btn'), saveTask: document.getElementById('save-task-btn'),
            exportData: document.getElementById('export-btn'), importData: document.getElementById('import-btn'), resetApp: document.getElementById('reset-app-btn'),
            calendarPrevMonth: document.getElementById('calendar-prev-month-btn'), calendarNextMonth: document.getElementById('calendar-next-month-btn'),
            toggleCompleted: document.getElementById('toggle-completed-btn'), addSubject: document.getElementById('add-subject-btn'),
            cancelSubjectForm: document.getElementById('cancel-subject-form-btn'), saveSubject: document.getElementById('save-subject-btn'),
            // Mobile Nav
            mobileDashboard: document.getElementById('mobile-dashboard-btn'), mobileCalendar: document.getElementById('mobile-calendar-btn'), mobileSchedule: document.getElementById('mobile-schedule-btn'),
            mobileSettings: document.getElementById('mobile-settings-btn'), mobileAddTask: document.getElementById('mobile-add-task-btn'),
            // Desktop Nav
            desktopDashboard: document.getElementById('desktop-dashboard-btn'), desktopCalendar: document.getElementById('desktop-calendar-btn'), desktopSchedule: document.getElementById('desktop-schedule-btn'),
            desktopSettings: document.getElementById('desktop-settings-btn'), desktopAddTask: document.getElementById('desktop-add-task-btn')
        };
        const inputs = { username: document.getElementById('username-input'), importFile: document.getElementById('import-file-input'), immersiveModeSwitch: document.getElementById('immersive-mode-switch') };
        const containers = {
            pendingTasks: document.getElementById('pending-tasks-container'), upcomingClasses: document.getElementById('upcoming-classes-container'), completedTasks: document.getElementById('completed-tasks-container'), completedTasksSection: document.getElementById('completed-tasks-section'),
            taskDetails: document.getElementById('task-details-content'), subtasksFormList: document.getElementById('subtasks-form-list'), themeSelector: document.getElementById('theme-selector'),
            calendarGrid: document.getElementById('calendar-grid'), calendarTitleDesktop: document.getElementById('calendar-title-desktop'),
            calendarTasks: document.getElementById('calendar-tasks-container'), scheduleList: document.getElementById('schedule-list-container'), grades: document.getElementById('grades-container'),
            greetingText: document.getElementById('greeting-text'), dashboardSummary: document.getElementById('dashboard-summary'), motivationalQuote: document.getElementById('motivational-quote')
        };
        const formElements = {
            setupForm: document.getElementById('setup-form'),
            form: document.getElementById('task-form'), formTitle: document.getElementById('form-title'), taskIdInput: document.getElementById('task-id-input'), title: document.getElementById('task-title'),
            description: document.getElementById('task-description'), dueDate: document.getElementById('task-due-date'), color1: document.getElementById('color-1'), color2: document.getElementById('color-2')
        };
        const subjectFormElements = {
            form: document.getElementById('subject-form'), formTitle: document.getElementById('subject-form-title'), idInput: document.getElementById('subject-id-input'), name: document.getElementById('subject-name'),
            day: document.getElementById('subject-day'), startTime: document.getElementById('subject-start-time'), endTime: document.getElementById('subject-end-time')
        };
        const modal = { element: document.getElementById('subtask-modal'), input: document.getElementById('subtask-input'), confirmBtn: document.getElementById('confirm-add-subtask-btn'), cancelBtn: document.getElementById('cancel-add-subtask-btn'), addBtnForm: document.getElementById('add-subtask-form-btn') };

        // ESTADO DE LA APLICACIÓN
        let state = { userName: null, tasks: [], schedule: [], grades: {}, currentView: 'setup', selectedTaskId: null, selectedSubjectId: null, tempSubtasks: [], calendarDate: new Date() };
        let countdownInterval = null;
        let scheduleInterval = null;
        let subtaskModalContext = { isFormContext: false, taskId: null };
        const themes = [ { id: 'default-light', name: 'Original' }, { id: 'pastel-dream-light', name: 'Pastel' }, { id: 'mint-choco-light', name: 'Menta' }, { id: 'autumn-crisp-light', name: 'Otoño' }, { id: 'beach-day-light', name: 'Playa' }, { id: 'deep-space-dark', name: 'Espacio' }, { id: 'forest-night-dark', name: 'Bosque' }, { id: 'vampire-dark', name: 'Vampiro' }, { id: 'cyberpunk-dark', name: 'Cyber' }, { id: 'cozy-autumn-dark', name: 'Otoño Osc' }];
        const motivationalQuotes = [ "El secreto para salir adelante es empezar.", "La disciplina es el puente entre las metas y los logros.", "No mires el reloj; haz lo que él hace. Sigue moviéndote.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "Cree que puedes y ya estás a medio camino." ];

        // --- LÓGICA DE DATOS Y CONFIGURACIÓN ---
        function loadData() { const savedData = localStorage.getItem('fluir-app-data'); if (savedData) { const parsedData = JSON.parse(savedData); state.userName = parsedData.userName || null; state.tasks = parsedData.tasks || []; state.schedule = parsedData.schedule || []; state.grades = parsedData.grades || {}; } }
        function saveData() { localStorage.setItem('fluir-app-data', JSON.stringify({ userName: state.userName, tasks: state.tasks, schedule: state.schedule, grades: state.grades })); }
        function exportData() { if (!state.userName) return alert("No hay datos para exportar."); const dataStr = JSON.stringify({ userName: state.userName, tasks: state.tasks, schedule: state.schedule, grades: state.grades }, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const a = document.createElement('a'); a.href = url; a.download = `fluir_backup_${new Date().toISOString().split('T')[0]}.flu`; a.click(); URL.revokeObjectURL(url); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (typeof importedData !== 'object' || !importedData.userName) throw new Error("Formato inválido."); if (confirm("¿Quieres sobrescribir tus datos actuales?")) { state.userName = importedData.userName; state.tasks = importedData.tasks || []; state.schedule = importedData.schedule || []; state.grades = importedData.grades || {}; saveData(); renderDashboard(); navigateTo('dashboard'); alert("¡Datos importados!"); } } catch (error) { alert(`Error al importar: ${error.message}`); } }; reader.readAsText(file); event.target.value = ''; }
        function applyTheme(themeId) { document.documentElement.dataset.theme = themeId; localStorage.setItem('fluir-theme', themeId); const style = getComputedStyle(document.documentElement); document.querySelector('label[for="color-1"]').style.backgroundColor = style.getPropertyValue('--card-color-1').trim(); document.querySelector('label[for="color-1"]').style.borderColor = style.getPropertyValue('--border-color').trim(); document.querySelector('label[for="color-2"]').style.backgroundColor = style.getPropertyValue('--card-color-2').trim(); document.querySelector('label[for="color-2"]').style.borderColor = style.getPropertyValue('--border-color').trim(); }
        function resetApp() { if(confirm("¡ADVERTENCIA!\n¿Estás seguro de que quieres reiniciar la aplicación?")){ localStorage.clear(); location.reload(); } }

        // --- LÓGICA DE MODO INMERSIVO ---
        function enterFullscreen() { if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); }
        function exitFullscreen() { if (document.exitFullscreen) document.exitFullscreen(); }
        function toggleImmersiveMode(force) { const isImmersive = force !== undefined ? force : inputs.immersiveModeSwitch.checked; if (isImmersive) enterFullscreen(); else exitFullscreen(); localStorage.setItem('fluir-immersive', isImmersive); inputs.immersiveModeSwitch.checked = isImmersive; }

        // --- LÓGICA DE NAVEGACIÓN ---
        function navigateTo(viewName) {
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            if (scheduleInterval) { clearInterval(scheduleInterval); scheduleInterval = null; }
            const currentViewElement = views[state.currentView]; const nextViewElement = views[viewName];
            if (currentViewElement && nextViewElement) {
                currentViewElement.classList.add('is-exiting');
                setTimeout(() => {
                    currentViewElement.classList.remove('active', 'is-exiting'); currentViewElement.style.display = 'none';
                    nextViewElement.style.display = 'block'; nextViewElement.classList.add('active', 'is-entering');
                    setTimeout(() => nextViewElement.classList.remove('is-entering'), 400);
                    state.currentView = viewName; updateNavActiveState(viewName); window.scrollTo(0, 0);
                    if (viewName === 'dashboard') { renderDashboard(); startCountdownTimers(); }
                    if (viewName === 'schedule') { startScheduleUpdater(); }
                    if (viewName === 'settings') { renderGrades(); }
                }, 400);
            }
        }
        function updateNavActiveState(activeView) {
            const mobileMapping = { dashboard: buttons.mobileDashboard, calendar: buttons.mobileCalendar, settings: buttons.mobileSettings, schedule: buttons.mobileSchedule };
            Object.values(mobileMapping).forEach(btn => btn.classList.remove('active'));
            if (mobileMapping[activeView]) mobileMapping[activeView].classList.add('active');
            
            const desktopMapping = { dashboard: buttons.desktopDashboard, calendar: buttons.desktopCalendar, settings: buttons.desktopSettings, schedule: buttons.desktopSchedule };
            Object.values(desktopMapping).forEach(btn => btn.classList.remove('active'));
            if (desktopMapping[activeView]) desktopMapping[activeView].classList.add('active');
        }
        
        // --- LÓGICA DEL CONTADOR ---
        function updateCountdownTimers() { document.querySelectorAll('.countdown-timer').forEach(timer => { const dueDate = new Date(timer.dataset.dueDate); const now = new Date(); const diff = dueDate - now; if (diff <= 0) { timer.innerHTML = '<span class="text-red-500 font-bold">Vencido</span>'; return; } const d = Math.floor(diff / (1000 * 60 * 60 * 24)); const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); const s = Math.floor((diff % (1000 * 60)) / 1000); timer.textContent = `${d > 0 ? d + 'd ' : ''}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; }); }
        function startCountdownTimers() { if (!countdownInterval) { updateCountdownTimers(); countdownInterval = setInterval(updateCountdownTimers, 1000); } }

        // --- LÓGICA DE RENDERIZADO ---
        function createProgressCircle(percentage, size = 40) { const sW = size / 10; const r = (size / 2) - (sW / 2); const c = 2 * Math.PI * r; const o = c - (percentage / 100) * c; const fg = "var(--text-primary)"; const bg = "var(--text-secondary)"; const textSize = size / 4.5; return `<svg style="width:${size}px; height:${size}px;" viewBox="0 0 ${size} ${size}"><circle stroke-width="${sW}" stroke="${bg}" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}"/><circle stroke-width="${sW}" stroke-dasharray="${c}" stroke-dashoffset="${o}" stroke-linecap="round" stroke="${fg}" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}" style="transition: stroke-dashoffset 0.5s ease; transform: rotate(-90deg); transform-origin: center;"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" class="font-bold" style="fill: ${fg}; font-size: ${textSize}px;">${Math.round(percentage)}%</text></svg>`; }
        
        function createTaskCard(task) { let progress = 0; let statusText = ''; if (task.subtasks.length > 0) { const completedSubtasks = task.subtasks.filter(st => st.completed).length; progress = (completedSubtasks / task.subtasks.length) * 100; statusText = `${completedSubtasks}/${task.subtasks.length}`; } else { progress = task.completed ? 100 : 0; statusText = task.completed ? '¡Hecho!' : 'Simple'; } const card = document.createElement('div'); card.className = 'task-card neo-brutalist p-4 flex justify-between items-center cursor-pointer'; card.style.backgroundColor = task.color; card.dataset.taskId = task.id; let timeInfoHTML = ''; if(task.dueDate && !task.completed) { const dueDateFormatted = new Date(task.dueDate).toLocaleString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); timeInfoHTML = `<p class="text-sm text-secondary">Entrega: ${dueDateFormatted}</p><p class="text-sm font-semibold countdown-timer" data-due-date="${task.dueDate}"></p>`; } else if (task.dueDate) { const dueDateFormatted = new Date(task.dueDate).toLocaleString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }); timeInfoHTML = `<p class="text-sm text-secondary">Completado el ${dueDateFormatted}</p>`; } else { timeInfoHTML = `<p class="text-sm text-secondary">Sin fecha de entrega</p>`; } card.innerHTML = `<div class="flex-grow mr-4 min-w-0"><h3 class="font-bold text-lg break-words ${task.completed ? 'line-through text-secondary' : ''}">${task.title}</h3>${timeInfoHTML}</div><div class="flex-shrink-0 flex flex-col items-center justify-center">${createProgressCircle(progress, 60)}<span class="text-xs font-semibold mt-1">${statusText}</span></div>`; card.addEventListener('click', () => { state.selectedTaskId = task.id; renderTaskDetails(); navigateTo('details'); }); return card; }

        function renderDashboard() {
            // Greeting
            containers.greetingText.textContent = `Hola, ${state.userName}!`;
            const pendingTaskCount = state.tasks.filter(t => !t.completed).length;
            containers.dashboardSummary.textContent = pendingTaskCount > 0 ? `Tienes ${pendingTaskCount} tarea${pendingTaskCount > 1 ? 's' : ''} pendiente${pendingTaskCount > 1 ? 's' : ''}.` : '¡No tienes tareas pendientes!';
            containers.motivationalQuote.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];

            // Pending Tasks
            containers.pendingTasks.innerHTML = '';
            const activeTasks = state.tasks.filter(t => !t.completed);
            const sortedTasks = activeTasks.sort((a, b) => { if (!a.dueDate) return 1; if (!b.dueDate) return -1; return new Date(a.dueDate) - new Date(b.dueDate); });
            if (sortedTasks.length > 0) { sortedTasks.forEach(task => containers.pendingTasks.appendChild(createTaskCard(task))); } else { containers.pendingTasks.innerHTML = getEmptyStateHTML("Todo en orden", "No hay tareas pendientes. ¡Añade una nueva!"); }
            
            // Upcoming Classes
            renderUpcomingClasses();

            // Completed Tasks
            const completedTasks = state.tasks.filter(t => t.completed);
            if (completedTasks.length > 0) {
                containers.completedTasksSection.classList.remove('hidden');
                containers.completedTasks.innerHTML = '';
                completedTasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(task => containers.completedTasks.appendChild(createTaskCard(task)));
            } else { containers.completedTasksSection.classList.add('hidden'); }
            startCountdownTimers();
        }

        function getUpcomingClasses() {
            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const currentDay = now.getDay();
            const tomorrowDay = (now.getDay() + 1) % 7;

            const upcoming = state.schedule.filter(s => {
                const [endH, endM] = s.endTime.split(':').map(Number);
                const endMinutes = endH * 60 + endM;
                return (s.day === currentDay && endMinutes > nowMinutes) || s.day === tomorrowDay;
            });

            return upcoming.sort((a, b) => {
                const aDay = a.day === currentDay ? 0 : 1;
                const bDay = b.day === currentDay ? 0 : 1;
                if (aDay !== bDay) return aDay - bDay;
                return a.startTime.localeCompare(b.startTime);
            }).slice(0, 3); // Show max 3 upcoming classes
        }

        function renderUpcomingClasses() {
            containers.upcomingClasses.innerHTML = '';
            const upcoming = getUpcomingClasses();
            if (upcoming.length > 0) {
                upcoming.forEach(s => {
                    const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const dayName = s.day === new Date().getDay() ? 'Hoy' : days[s.day];
                    const card = document.createElement('div');
                    card.className = 'class-card neo-brutalist p-4 cursor-pointer';
                    card.style.backgroundColor = 'var(--card-color-2)';
                    card.innerHTML = `
                        <h3 class="font-bold text-lg break-words">${s.name}</h3>
                        <p class="text-md text-secondary">${dayName} a las ${s.startTime}</p>
                    `;
                    card.addEventListener('click', () => navigateTo('schedule'));
                    containers.upcomingClasses.appendChild(card);
                });
            } else {
                containers.upcomingClasses.innerHTML = getEmptyStateHTML("Tiempo libre", "No tienes clases programadas próximamente.");
            }
        }
        
        function renderTaskDetails() { const task = state.tasks.find(t => t.id === state.selectedTaskId); if (!task) return; let progress = 0; if (task.subtasks.length > 0) { const completed = task.subtasks.filter(st => st.completed).length; progress = (completed / task.subtasks.length) * 100; } else { progress = task.completed ? 100 : 0; } let detailsHTML = `<div class="flex flex-col items-center w-full">`; detailsHTML += `<div class="mb-6">${createProgressCircle(progress, 120)}</div>`; detailsHTML += `<h2 class="font-heading text-3xl md:text-5xl uppercase mb-2 text-center break-words ${task.completed ? 'line-through text-secondary' : ''}">${task.title}</h2>`; detailsHTML += `<div class="text-sm text-secondary mb-6 text-center"><span>Creado: ${new Date(task.createdAt).toLocaleDateString()}</span> | <span>Entrega: ${task.dueDate ? new Date(task.dueDate).toLocaleString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit'}) : 'Sin fecha'}</span></div>`; detailsHTML += `<p class="mb-8 text-center w-full max-w-2xl">${task.description || '<em>Sin descripción.</em>'}</p>`; detailsHTML += `<div class="w-full border-t-2 pt-6" style="border-color: var(--border-color);">`; if (task.subtasks.length > 0) { const comp = task.subtasks.filter(st => st.completed).length; const total = task.subtasks.length; const subsHTML = task.subtasks.map(st => `<div class="flex items-center gap-4 p-3 border-b-2" style="border-color: var(--border-color);"><input type="checkbox" id="subtask-${st.id}" data-subtask-id="${st.id}" class="custom-checkbox" ${st.completed ? 'checked' : ''}><label for="subtask-${st.id}" class="flex-1 ${st.completed ? 'line-through text-secondary' : ''}">${st.text}</label></div>`).join(''); detailsHTML += `<h3 class="font-heading text-xl uppercase mb-4">Progreso (${comp}/${total})</h3><div id="subtasks-details-list">${subsHTML}</div><button id="add-subtask-details-btn" class="mt-4 neo-brutalist btn-secondary text-sm font-bold px-3 py-1.5">+ Añadir subtarea</button>`; } else { detailsHTML += `<div class="flex justify-center"><label for="complete-task-checkbox" class="flex items-center gap-4 cursor-pointer"><input type="checkbox" id="complete-task-checkbox" class="custom-checkbox w-8 h-8" ${task.completed ? 'checked' : ''}><span class="text-xl font-bold">Marcar como completada</span></label></div>`; } detailsHTML += `</div></div>`; containers.taskDetails.innerHTML = detailsHTML; if (task.subtasks.length > 0) { document.querySelectorAll('#subtasks-details-list input[type="checkbox"]').forEach(cb => { cb.addEventListener('change', e => { const subtask = task.subtasks.find(st => st.id === e.target.dataset.subtaskId); if(subtask) { subtask.completed = e.target.checked; task.completed = task.subtasks.every(st => st.completed); saveData(); renderTaskDetails(); } }); }); document.getElementById('add-subtask-details-btn').addEventListener('click', () => { openSubtaskModal(false, task.id); }); } else { document.getElementById('complete-task-checkbox').addEventListener('change', e => { task.completed = e.target.checked; saveData(); renderTaskDetails(); }); } }
        
        function renderFormSubtasks() { containers.subtasksFormList.innerHTML = state.tempSubtasks.map((st, i) => `<div class="flex items-center justify-between p-2 neo-brutalist-flat" style="background-color: var(--bg-env);"><span class="text-secondary">${st.text}</span><button type="button" class="font-bold text-red-500 px-2" data-index="${i}" aria-label="Eliminar subtarea">×</button></div>`).join(''); containers.subtasksFormList.querySelectorAll('button').forEach(btn => btn.addEventListener('click', e => { state.tempSubtasks.splice(e.target.dataset.index, 1); renderFormSubtasks(); })); }
        function getEmptyStateHTML(title, message) { return `<div class="col-span-full text-center p-8 md:p-12 neo-brutalist-flat" style="background-color: var(--bg-main);"><h3 class="font-heading text-xl uppercase">${title}</h3><p class="mt-1 text-sm text-secondary">${message}</p></div>`; }
        function renderCalendar() { containers.calendarGrid.innerHTML = ''; const d = state.calendarDate; const y = d.getFullYear(); const m = d.getMonth(); const t = d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase(); containers.calendarTitleDesktop.textContent = t; const fD = new Date(y, m, 1).getDay(); const dM = new Date(y, m + 1, 0).getDate(); ['D', 'L', 'M', 'X', 'J', 'V', 'S'].forEach(day => containers.calendarGrid.innerHTML += `<div class="p-2 border-b-2" style="border-color: var(--border-color);">${day}</div>`); const tD = {}; state.tasks.forEach(task => { if(task.dueDate){ const tDate = task.dueDate.split('T')[0]; if(!tD[tDate]) tD[tDate] = []; tD[tDate].push(task); }}); for (let i = 0; i < (fD === 0 ? 6 : fD - 1); i++) containers.calendarGrid.innerHTML += `<div></div>`; for (let day = 1; day <= dM; day++) { const el = document.createElement('div'); const fDate = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; el.className = 'p-2 cursor-pointer rounded-full relative hover:bg-gray-200'; el.textContent = day; el.dataset.date = fDate; if (tD[fDate]) { el.innerHTML += `<span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full" style="background-color: var(--accent-primary);"></span>`; el.classList.add('font-extrabold'); } el.addEventListener('click', () => renderTasksForDay(fDate, tD[fDate] || [])); containers.calendarGrid.appendChild(el); } }
        function renderTasksForDay(dateStr, tasks) { const date = new Date(dateStr + 'T00:00:00'); containers.calendarTasks.innerHTML = `<h3 class="font-heading text-xl uppercase mb-2">Tareas para el ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</h3>`; if(tasks.length > 0) { tasks.forEach(task => { const el = document.createElement('div'); el.className = 'p-3 neo-brutalist-flat cursor-pointer'; el.style.backgroundColor = task.color; el.textContent = task.title; el.addEventListener('click', () => { state.selectedTaskId = task.id; renderTaskDetails(); navigateTo('details'); }); containers.calendarTasks.appendChild(el); }); } else { containers.calendarTasks.innerHTML += `<p class="text-secondary">No hay tareas programadas.</p>`; } }
        
        function renderSchedule() {
            containers.scheduleList.innerHTML = '';
            if (state.schedule.length === 0) {
                containers.scheduleList.innerHTML = getEmptyStateHTML("Tu horario está vacío", "Añade tu primera materia para empezar a organizarte.");
                return;
            }
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const scheduleByDay = days.map(() => []).map((_, dayIndex) => state.schedule.filter(s => s.day === dayIndex).sort((a,b) => a.startTime.localeCompare(b.startTime)));
            
            const upcomingClasses = getUpcomingClasses();
            const nextClassId = upcomingClasses.length > 0 ? upcomingClasses[0].id : null;

            days.forEach((dayName, dayIndex) => {
                if (scheduleByDay[dayIndex].length > 0) {
                    const dayGroup = document.createElement('div');
                    dayGroup.className = 'schedule-day-group space-y-3';
                    dayGroup.dataset.dayIndex = dayIndex;
                    let dayHTML = `<h3 class="font-heading text-2xl uppercase pb-2 border-b-2" style="border-color: var(--border-color);">${dayName}</h3>`;
                    scheduleByDay[dayIndex].forEach(s => {
                        dayHTML += `
                            <div id="subject-${s.id}" class="class-card neo-brutalist-flat p-3 flex justify-between items-center cursor-pointer ${s.id === nextClassId ? 'next-class' : ''}" style="background-color: var(--card-color-1);">
                                <span class="font-bold">${s.name}</span>
                                <span class="text-secondary font-semibold">${s.startTime} - ${s.endTime}</span>
                            </div>`;
                    });
                    dayGroup.innerHTML = dayHTML;
                    containers.scheduleList.appendChild(dayGroup);
                    dayGroup.querySelectorAll('.neo-brutalist-flat').forEach((el, i) => {
                        const subjectId = scheduleByDay[dayIndex][i].id;
                        el.addEventListener('click', () => openEditSubjectForm(subjectId));
                    });
                }
            });
            updateScheduleTimeIndicator();
        }

        function updateScheduleTimeIndicator() {
            let indicator = document.querySelector('.schedule-time-indicator');
            if (indicator) indicator.remove();

            const now = new Date();
            const currentDayIndex = now.getDay();
            const dayGroupEl = containers.scheduleList.querySelector(`.schedule-day-group[data-day-index="${currentDayIndex}"]`);
            if (!dayGroupEl) return;

            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const classesEl = dayGroupEl.querySelectorAll('.neo-brutalist-flat');
            
            for(let i=0; i < classesEl.length; i++) {
                const classEl = classesEl[i];
                const subjectId = classEl.id.replace('subject-', '');
                const subject = state.schedule.find(s => s.id === subjectId);
                if (!subject) continue;

                const [startH, startM] = subject.startTime.split(':').map(Number);
                const [endH, endM] = subject.endTime.split(':').map(Number);
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;

                if (nowMinutes >= startMinutes && nowMinutes < endMinutes) {
                    const duration = endMinutes - startMinutes;
                    const progress = (nowMinutes - startMinutes) / duration;
                    const top = classEl.offsetTop + (classEl.offsetHeight * progress);

                    indicator = document.createElement('div');
                    indicator.className = 'schedule-time-indicator';
                    indicator.style.top = `${top}px`;
                    dayGroupEl.appendChild(indicator);
                    break;
                }
            }
        }

        function startScheduleUpdater() {
            renderSchedule();
            scheduleInterval = setInterval(renderSchedule, 60000); // Update every minute
        }

        function renderGrades() {
            containers.grades.innerHTML = '';
            if (state.schedule.length === 0) {
                containers.grades.innerHTML = `<p class="text-sm text-secondary">No hay materias registradas en el horario. Añade materias para poder registrar sus calificaciones.</p>`;
                return;
            }
            const subjects = [...new Map(state.schedule.map(item => [item.name, item])).values()]; // Unique subjects by name
            subjects.sort((a,b) => a.name.localeCompare(b.name));
            subjects.forEach(subject => {
                const gradeEl = document.createElement('div');
                gradeEl.className = 'flex items-center justify-between p-3 neo-brutalist-flat'
                gradeEl.style.backgroundColor = 'var(--bg-env)';
                gradeEl.innerHTML = `
                    <label for="grade-${subject.id}" class="font-bold">${subject.name}</label>
                    <input type="number" id="grade-${subject.id}" data-subject-id="${subject.id}" value="${state.grades[subject.id] || ''}" min="0" max="10" step="0.1" class="input-field w-24 text-center" placeholder="N/A">
                `;
                containers.grades.appendChild(gradeEl);
            });
            containers.grades.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const subjectId = e.target.dataset.subjectId;
                    const value = e.target.value;
                    if (value === '') { delete state.grades[subjectId]; }
                    else { state.grades[subjectId] = parseFloat(value); }
                    saveData();
                });
            });
        }

        function openSubtaskModal(isFormCtx, taskId = null) { subtaskModalContext = { isFormContext: isFormCtx, taskId }; modal.element.classList.add('active'); modal.input.value = ''; modal.input.focus(); }
        function closeSubtaskModal() { modal.element.classList.remove('active'); }
        function handleAddSubtask() { const text = modal.input.value.trim(); if (!text) return; if (subtaskModalContext.isFormContext) { state.tempSubtasks.push({ text, completed: false }); renderFormSubtasks(); } else { const task = state.tasks.find(t => t.id === subtaskModalContext.taskId); if (task) { task.subtasks.push({ id: `sub-${Date.now()}`, text, completed: false }); saveData(); renderTaskDetails(); } } closeSubtaskModal(); }
        
        function openNewTaskForm() { state.selectedTaskId = null; formElements.form.reset(); formElements.formTitle.textContent = 'Nuevo Proyecto'; buttons.saveTask.textContent = 'Crear Proyecto'; state.tempSubtasks = []; renderFormSubtasks(); navigateTo('form'); }
        function openEditTaskForm(taskId) { const task = state.tasks.find(t => t.id === taskId); if (!task) return; state.selectedTaskId = taskId; formElements.form.reset(); formElements.formTitle.textContent = 'Editar Proyecto'; buttons.saveTask.textContent = 'Guardar Cambios'; formElements.title.value = task.title; formElements.description.value = task.description; if (task.dueDate) { const d = new Date(task.dueDate); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const hours = String(d.getHours()).padStart(2, '0'); const minutes = String(d.getMinutes()).padStart(2, '0'); formElements.dueDate.value = `${year}-${month}-${day}T${hours}:${minutes}`; } else { formElements.dueDate.value = ''; } if (task.color === 'var(--card-color-2)') { formElements.color2.checked = true; } else { formElements.color1.checked = true; } state.tempSubtasks = JSON.parse(JSON.stringify(task.subtasks)); renderFormSubtasks(); navigateTo('form'); }
        
        function openNewSubjectForm() { state.selectedSubjectId = null; subjectFormElements.form.reset(); subjectFormElements.formTitle.textContent = 'Nueva Materia'; buttons.saveSubject.textContent = 'Añadir Materia'; navigateTo('subjectForm'); }
        function openEditSubjectForm(subjectId) { const subject = state.schedule.find(s => s.id === subjectId); if (!subject) return; state.selectedSubjectId = subjectId; subjectFormElements.form.reset(); subjectFormElements.formTitle.textContent = 'Editar Materia'; buttons.saveSubject.textContent = 'Guardar Cambios'; subjectFormElements.name.value = subject.name; subjectFormElements.day.value = subject.day; subjectFormElements.startTime.value = subject.startTime; subjectFormElements.endTime.value = subject.endTime; navigateTo('subjectForm'); }

        // --- EVENT HANDLERS ---
        formElements.setupForm.addEventListener('submit', (e) => { e.preventDefault(); const name = inputs.username.value.trim(); if(name){ state.userName = name; saveData(); renderDashboard(); navigateTo('dashboard'); } });
        
        // Add Task Buttons
        buttons.mobileAddTask.addEventListener('click', openNewTaskForm);
        buttons.desktopAddTask.addEventListener('click', openNewTaskForm);

        buttons.addSubject.addEventListener('click', openNewSubjectForm);
        buttons.backToDashboard.addEventListener('click', () => { renderDashboard(); navigateTo('dashboard'); });
        buttons.editTask.addEventListener('click', () => { if (state.selectedTaskId) openEditTaskForm(state.selectedTaskId); });
        buttons.cancelForm.addEventListener('click', () => { if (state.selectedTaskId) { renderTaskDetails(); navigateTo('details'); } else { renderDashboard(); navigateTo('dashboard'); } });
        buttons.cancelSubjectForm.addEventListener('click', () => { renderSchedule(); navigateTo('schedule'); });
        
        formElements.form.addEventListener('submit', (e) => { e.preventDefault(); const title = formElements.title.value.trim(); if (!title) return; const commonData = { title, description: formElements.description.value.trim(), dueDate: formElements.dueDate.value, color: formElements.color1.checked ? 'var(--card-color-1)' : 'var(--card-color-2)', subtasks: state.tempSubtasks.map((st, i) => ({ id: st.id || `sub-${Date.now()}-${i}`, text: st.text, completed: st.completed || false })) }; if (state.selectedTaskId) { const taskIndex = state.tasks.findIndex(t => t.id === state.selectedTaskId); if (taskIndex > -1) { const originalTask = state.tasks[taskIndex]; const updatedTask = { ...originalTask, ...commonData }; updatedTask.completed = updatedTask.subtasks.length > 0 ? updatedTask.subtasks.every(st => st.completed) : (updatedTask.subtasks.length === 0 ? false : originalTask.completed); state.tasks[taskIndex] = updatedTask; saveData(); renderTaskDetails(); navigateTo('details'); } } else { const newTask = { ...commonData, id: `task-${Date.now()}`, createdAt: new Date().toISOString(), completed: false }; newTask.subtasks.forEach(st => st.completed = false); state.tasks.push(newTask); saveData(); renderDashboard(); navigateTo('dashboard'); } });
        subjectFormElements.form.addEventListener('submit', (e) => { e.preventDefault(); const name = subjectFormElements.name.value.trim(); if (!name) return; const subjectData = { name, day: parseInt(subjectFormElements.day.value), startTime: subjectFormElements.startTime.value, endTime: subjectFormElements.endTime.value }; if (state.selectedSubjectId) { const index = state.schedule.findIndex(s => s.id === state.selectedSubjectId); if (index > -1) state.schedule[index] = { ...state.schedule[index], ...subjectData }; } else { state.schedule.push({ ...subjectData, id: `sub-${Date.now()}` }); } saveData(); renderSchedule(); navigateTo('schedule'); });
        
        // Navigation Events
        buttons.mobileDashboard.addEventListener('click', () => navigateTo('dashboard'));
        buttons.desktopDashboard.addEventListener('click', () => navigateTo('dashboard'));
        buttons.mobileCalendar.addEventListener('click', () => { renderCalendar(); navigateTo('calendar'); });
        buttons.desktopCalendar.addEventListener('click', () => { renderCalendar(); navigateTo('calendar'); });
        buttons.mobileSchedule.addEventListener('click', () => navigateTo('schedule'));
        buttons.desktopSchedule.addEventListener('click', () => navigateTo('schedule'));
        buttons.mobileSettings.addEventListener('click', () => navigateTo('settings'));
        buttons.desktopSettings.addEventListener('click', () => navigateTo('settings'));

        // Settings & Data Events
        buttons.importData.addEventListener('click', () => inputs.importFile.click());
        inputs.importFile.addEventListener('change', importData);
        buttons.exportData.addEventListener('click', exportData);
        buttons.resetApp.addEventListener('click', resetApp);
        
        // Calendar Events
        const prevMonthAction = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); };
        const nextMonthAction = () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); };
        buttons.calendarPrevMonth.addEventListener('click', prevMonthAction); 
        buttons.calendarNextMonth.addEventListener('click', nextMonthAction);
        
        // Modal Events
        modal.addBtnForm.addEventListener('click', () => openSubtaskModal(true)); 
        modal.confirmBtn.addEventListener('click', handleAddSubtask); 
        modal.cancelBtn.addEventListener('click', closeSubtaskModal);
        modal.input.addEventListener('keydown', e => { if (e.key === 'Enter') handleAddSubtask(); });
        
        // Other Events
        inputs.immersiveModeSwitch.addEventListener('change', () => toggleImmersiveMode());
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) { inputs.immersiveModeSwitch.checked = false; localStorage.setItem('fluir-immersive', false); }});
        buttons.toggleCompleted.addEventListener('click', (e) => { const isHidden = containers.completedTasks.classList.toggle('hidden'); e.target.textContent = isHidden ? 'Mostrar' : 'Ocultar'; });
        
        // --- INITIALIZATION ---
        function init() {
            setTimeout(() => { splashScreen.classList.add('is-fading'); setTimeout(() => { splashScreen.style.display = 'none'; }, 500); }, 1500);
            
            loadData();

            const savedTheme = localStorage.getItem('fluir-theme') || 'default-light';
            containers.themeSelector.innerHTML = themes.map(theme => `<div class="flex items-center gap-2"><input type="radio" id="theme-${theme.id}" name="theme" value="${theme.id}" class="custom-checkbox" ${savedTheme === theme.id ? 'checked' : ''}><label for="theme-${theme.id}" class="font-bold">${theme.name}</label></div>`).join('');
            applyTheme(savedTheme);
            containers.themeSelector.addEventListener('change', e => applyTheme(e.target.value));
            
            const isImmersive = localStorage.getItem('fluir-immersive') === 'true';
            if(isImmersive) toggleImmersiveMode(true);
            
            if (state.userName) {
                renderDashboard();
                navigateTo('dashboard');
            } else {
                views.setup.classList.add('active');
                state.currentView = 'setup';
                updateNavActiveState('setup');
            }
        }
        
        init();
    });
    </script>

    <!-- PWA: Script para registrar el Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            });
        }
    </script>
    
</body>
</html>